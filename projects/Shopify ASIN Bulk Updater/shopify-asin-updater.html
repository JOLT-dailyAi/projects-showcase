<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify ASIN Bulk Updater</title>
    <!-- Link to centralized styles.css (2 folders up) -->
    <link rel="stylesheet" href="../../styles.css">
    <style>
        /* Additional styles specific to the ASIN updater */
        .updater-container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--ig-space-lg);
        }

        .updater-card {
            background: var(--ig-surface-elevated);
            border: 1px solid var(--ig-border);
            border-radius: var(--ig-radius-lg);
            padding: var(--ig-space-xl);
            margin-bottom: var(--ig-space-lg);
            box-shadow: var(--ig-shadow-md);
            transition: var(--ig-transition);
        }

        .updater-card:hover {
            box-shadow: var(--ig-shadow-lg);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--ig-space-sm);
            margin-bottom: var(--ig-space-lg);
            color: var(--ig-blue);
            font-weight: 600;
            font-size: 18px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--ig-space-lg);
            margin-bottom: var(--ig-space-lg);
        }

        .form-field {
            margin-bottom: var(--ig-space-md);
        }

        .form-label {
            display: block;
            color: var(--ig-text-primary);
            font-weight: 600;
            margin-bottom: var(--ig-space-sm);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: var(--ig-space-md);
            background: var(--ig-surface);
            border: 1px solid var(--ig-border);
            border-radius: var(--ig-radius-md);
            color: var(--ig-text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: var(--ig-transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--ig-blue);
            box-shadow: 0 0 0 3px rgba(0, 149, 246, 0.1);
        }

        .form-input::placeholder {
            color: var(--ig-text-muted);
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--ig-space-md);
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--ig-space-sm);
            padding: var(--ig-space-md) var(--ig-space-lg);
            border: none;
            border-radius: var(--ig-radius-md);
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--ig-transition);
            text-decoration: none;
            min-height: 48px;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-test {
            background: var(--ig-gradient-tech);
            color: white;
        }

        .btn-test:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--ig-shadow-lg);
        }

        .btn-preview {
            background: var(--ig-surface-hover);
            color: var(--ig-text-primary);
            border: 1px solid var(--ig-border-light);
        }

        .btn-preview:hover:not(:disabled) {
            background: var(--ig-border-light);
            transform: translateY(-2px);
        }

        .btn-update {
            background: var(--ig-gradient-brand);
            color: white;
        }

        .btn-update:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--ig-shadow-lg);
        }

        .btn-stop {
            background: linear-gradient(135deg, var(--ig-red), #dc2626);
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(237, 73, 86, 0.3);
        }

        .progress-container {
            margin: var(--ig-space-lg) 0;
            padding: var(--ig-space-lg);
            background: var(--ig-surface);
            border: 1px solid var(--ig-border);
            border-radius: var(--ig-radius-md);
            display: none;
        }

        .progress-track {
            width: 100%;
            height: 8px;
            background: var(--ig-border);
            border-radius: var(--ig-radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--ig-gradient-brand);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: var(--ig-radius-full);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--ig-space-md);
            margin: var(--ig-space-lg) 0;
            display: none;
        }

        .stat-item {
            background: var(--ig-surface);
            padding: var(--ig-space-lg);
            border-radius: var(--ig-radius-md);
            text-align: center;
            border: 1px solid var(--ig-border);
            transition: var(--ig-transition);
        }

        .stat-item:hover {
            background: var(--ig-surface-hover);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--ig-blue);
            display: block;
            margin-bottom: var(--ig-space-xs);
        }

        .stat-label {
            color: var(--ig-text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .log-container {
            margin-top: var(--ig-space-lg);
            background: var(--ig-surface-elevated);
            border: 1px solid var(--ig-border);
            border-radius: var(--ig-radius-md);
            display: none;
        }

        .log-header {
            padding: var(--ig-space-md);
            border-bottom: 1px solid var(--ig-border);
            font-weight: 600;
            color: var(--ig-text-primary);
            display: flex;
            align-items: center;
            gap: var(--ig-space-sm);
        }

        .log-content {
            padding: var(--ig-space-md);
            background: #1a1a1a;
            color: var(--ig-text-primary);
            font-family: 'Monaco', 'Consolas', 'SF Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .status-message {
            padding: var(--ig-space-md);
            border-radius: var(--ig-radius-md);
            margin: var(--ig-space-lg) 0;
            display: none;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-success {
            background: rgba(66, 216, 131, 0.1);
            border-left-color: var(--ig-green);
            color: var(--ig-green);
        }

        .status-error {
            background: rgba(237, 73, 86, 0.1);
            border-left-color: var(--ig-red);
            color: var(--ig-red);
        }

        .status-info {
            background: rgba(0, 149, 246, 0.1);
            border-left-color: var(--ig-blue);
            color: var(--ig-blue);
        }

        .status-warning {
            background: rgba(255, 205, 60, 0.1);
            border-left-color: var(--ig-yellow);
            color: var(--ig-yellow);
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
                gap: var(--ig-space-md);
            }

            .button-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .updater-container {
                padding: var(--ig-space-md);
            }

            .updater-card {
                padding: var(--ig-space-lg);
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="updater-container">
        <div class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="title-text">Shopify ASIN Bulk Updater</span>
                </h1>
                <p class="hero-subtitle">
                    Automatically copy SKU values to amazon.asin metafields for seamless affiliate link management
                </p>
            </div>
        </div>

        <div class="ig-alert ig-alert-warning">
            <strong>‚ö†Ô∏è Important:</strong> This tool will copy SKU values to amazon.asin metafields for products where the SKU looks like a valid ASIN (10 characters, starts with 'B'). Make sure to test on a few products first!
        </div>

        <div class="ig-alert ig-alert-info">
            <strong>üìã Setup Requirements:</strong>
            <br>‚Ä¢ Shopify Admin API access token with product read/write permissions
            <br>‚Ä¢ Your store's .myshopify.com domain name
            <br>‚Ä¢ Products with SKUs containing ASINs (like B0FN85HZYV)
        </div>

        <div class="updater-card">
            <div class="section-header">
                üîß Configuration
            </div>
            
            <div class="config-grid">
                <div class="form-field">
                    <label class="form-label" for="shopName">Store Name (without .myshopify.com)</label>
                    <input type="text" id="shopName" class="form-input" placeholder="your-store-name" />
                </div>
                
                <div class="form-field">
                    <label class="form-label" for="batchSize">Batch Size (products per request)</label>
                    <input type="number" id="batchSize" class="form-input" value="10" min="1" max="50" />
                </div>
            </div>
            
            <div class="form-field">
                <label class="form-label" for="accessToken">Admin API Access Token</label>
                <input type="password" id="accessToken" class="form-input" placeholder="shpat_..." />
            </div>
        </div>

        <div class="updater-card">
            <div class="section-header">
                üöÄ Actions
            </div>
            
            <div class="button-grid">
                <button class="action-btn btn-test" onclick="testConnection()">
                    üîç Test Connection
                </button>
                <button class="action-btn btn-preview" onclick="previewUpdates()" id="previewBtn">
                    üëÄ Preview Updates
                </button>
                <button class="action-btn btn-update" onclick="startBulkUpdate()" id="updateBtn" disabled>
                    ‚ñ∂Ô∏è Start Bulk Update
                </button>
                <button class="action-btn btn-stop" onclick="stopUpdate()" id="stopBtn" disabled>
                    ‚èπÔ∏è Stop
                </button>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="section-header" style="margin-bottom: var(--ig-space-md);">
                üìä Progress
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-item">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="eligibleProducts">0</div>
                <div class="stat-label">Eligible for Update</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="updatedProducts">0</div>
                <div class="stat-label">Updated</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="skippedProducts">0</div>
                <div class="stat-label">Skipped</div>
            </div>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="log-container" id="logContainer">
            <div class="log-header">
                üìù Activity Log
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let shouldStop = false;
        let stats = {
            total: 0,
            eligible: 0,
            updated: 0,
            skipped: 0
        };

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function log(message) {
            const logEl = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            document.getElementById('logContainer').style.display = 'block';
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = stats.total;
            document.getElementById('eligibleProducts').textContent = stats.eligible;
            document.getElementById('updatedProducts').textContent = stats.updated;
            document.getElementById('skippedProducts').textContent = stats.skipped;
            document.getElementById('statsGrid').style.display = 'grid';
        }

        function updateProgress(current, total) {
            const percentage = total > 0 ? (current / total) * 100 : 0;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressContainer').style.display = 'block';
        }

        function isValidASIN(sku) {
            return sku && 
                   sku.length === 10 && 
                   sku.charAt(0) === 'B' && 
                   /^[A-Z0-9]+$/.test(sku);
        }

        function getConfig() {
            const shopName = document.getElementById('shopName').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            const batchSize = parseInt(document.getElementById('batchSize').value) || 10;

            if (!shopName || !accessToken) {
                throw new Error('Please provide both shop name and access token');
            }

            return { shopName, accessToken, batchSize };
        }

        async function makeGraphQLRequest(query, variables = {}) {
            const config = getConfig();
            
            const response = await fetch(`https://${config.shopName}.myshopify.com/admin/api/2024-01/graphql.json`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Shopify-Access-Token': config.accessToken
                },
                body: JSON.stringify({ query, variables })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.errors) {
                throw new Error(`GraphQL errors: ${JSON.stringify(result.errors)}`);
            }

            return result.data;
        }

        async function testConnection() {
            try {
                log('Testing connection...');
                
                const query = `query { shop { name } }`;
                const data = await makeGraphQLRequest(query);
                
                showStatus(`‚úÖ Connected successfully to: ${data.shop.name}`, 'success');
                log(`Connected to shop: ${data.shop.name}`);
                
                document.getElementById('previewBtn').disabled = false;
                
            } catch (error) {
                showStatus(`‚ùå Connection failed: ${error.message}`, 'error');
                log(`Connection error: ${error.message}`);
            }
        }

        async function previewUpdates() {
            try {
                log('Starting preview...');
                stats = { total: 0, eligible: 0, updated: 0, skipped: 0 };

                const query = `
                    query getProducts($first: Int!, $after: String) {
                        products(first: $first, after: $after) {
                            pageInfo {
                                hasNextPage
                                endCursor
                            }
                            edges {
                                node {
                                    id
                                    title
                                    handle
                                    variants(first: 1) {
                                        edges {
                                            node {
                                                sku
                                            }
                                        }
                                    }
                                    metafields(namespace: "amazon", first: 5) {
                                        edges {
                                            node {
                                                key
                                                value
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                `;

                let hasNextPage = true;
                let cursor = null;
                const config = getConfig();

                while (hasNextPage) {
                    const data = await makeGraphQLRequest(query, {
                        first: config.batchSize,
                        after: cursor
                    });

                    const products = data.products.edges;
                    hasNextPage = data.products.pageInfo.hasNextPage;
                    cursor = data.products.pageInfo.endCursor;

                    for (const productEdge of products) {
                        const product = productEdge.node;
                        stats.total++;

                        const sku = product.variants.edges[0]?.node?.sku;
                        const existingASIN = product.metafields.edges.find(m => m.node.key === 'asin')?.node?.value;

                        if (isValidASIN(sku) && !existingASIN) {
                            stats.eligible++;
                            log(`‚úì Eligible: ${product.title} (SKU: ${sku})`);
                        } else if (existingASIN) {
                            stats.skipped++;
                            log(`- Skipped (has ASIN): ${product.title}`);
                        } else {
                            stats.skipped++;
                            log(`- Skipped (invalid SKU): ${product.title} (${sku || 'no SKU'})`);
                        }
                    }

                    updateStats();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                showStatus(`Preview complete! Found ${stats.eligible} products eligible for update out of ${stats.total} total products.`, 'info');
                document.getElementById('updateBtn').disabled = stats.eligible === 0;

            } catch (error) {
                showStatus(`‚ùå Preview failed: ${error.message}`, 'error');
                log(`Preview error: ${error.message}`);
            }
        }

        async function startBulkUpdate() {
            if (isRunning) return;
            
            isRunning = true;
            shouldStop = false;
            document.getElementById('updateBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            try {
                log('Starting bulk update...');
                stats = { total: 0, eligible: 0, updated: 0, skipped: 0 };

                const getProductsQuery = `
                    query getProducts($first: Int!, $after: String) {
                        products(first: $first, after: $after) {
                            pageInfo {
                                hasNextPage
                                endCursor
                            }
                            edges {
                                node {
                                    id
                                    title
                                    handle
                                    variants(first: 1) {
                                        edges {
                                            node {
                                                sku
                                            }
                                        }
                                    }
                                    metafields(namespace: "amazon", first: 5) {
                                        edges {
                                            node {
                                                key
                                                value
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                `;

                const updateProductMutation = `
                    mutation productUpdate($input: ProductInput!) {
                        productUpdate(input: $input) {
                            product {
                                id
                                title
                            }
                            userErrors {
                                field
                                message
                            }
                        }
                    }
                `;

                let hasNextPage = true;
                let cursor = null;
                const config = getConfig();
                const eligibleProducts = [];

                // First pass: collect eligible products
                while (hasNextPage && !shouldStop) {
                    const data = await makeGraphQLRequest(getProductsQuery, {
                        first: config.batchSize,
                        after: cursor
                    });

                    const products = data.products.edges;
                    hasNextPage = data.products.pageInfo.hasNextPage;
                    cursor = data.products.pageInfo.endCursor;

                    for (const productEdge of products) {
                        const product = productEdge.node;
                        stats.total++;

                        const sku = product.variants.edges[0]?.node?.sku;
                        const existingASIN = product.metafields.edges.find(m => m.node.key === 'asin')?.node?.value;

                        if (isValidASIN(sku) && !existingASIN) {
                            eligibleProducts.push({
                                id: product.id,
                                title: product.title,
                                sku: sku
                            });
                            stats.eligible++;
                        } else {
                            stats.skipped++;
                        }
                    }

                    updateStats();
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // Second pass: update eligible products
                for (let i = 0; i < eligibleProducts.length && !shouldStop; i++) {
                    const product = eligibleProducts[i];
                    
                    try {
                        const updateData = await makeGraphQLRequest(updateProductMutation, {
                            input: {
                                id: product.id,
                                metafields: [{
                                    namespace: "amazon",
                                    key: "asin",
                                    value: product.sku,
                                    type: "single_line_text_field"
                                }]
                            }
                        });

                        if (updateData.productUpdate.userErrors.length > 0) {
                            log(`‚ùå Error updating ${product.title}: ${updateData.productUpdate.userErrors[0].message}`);
                        } else {
                            stats.updated++;
                            log(`‚úÖ Updated: ${product.title} (ASIN: ${product.sku})`);
                        }

                    } catch (error) {
                        log(`‚ùå Failed to update ${product.title}: ${error.message}`);
                    }

                    updateProgress(i + 1, eligibleProducts.length);
                    updateStats();
                    
                    // Rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (shouldStop) {
                    showStatus('Update stopped by user', 'warning');
                    log('Update stopped by user');
                } else {
                    showStatus(`‚úÖ Bulk update completed! Updated ${stats.updated} out of ${stats.eligible} eligible products.`, 'success');
                    log(`Bulk update completed. Updated: ${stats.updated}, Total eligible: ${stats.eligible}`);
                }

            } catch (error) {
                showStatus(`‚ùå Bulk update failed: ${error.message}`, 'error');
                log(`Bulk update error: ${error.message}`);
            } finally {
                isRunning = false;
                document.getElementById('updateBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function stopUpdate() {
            shouldStop = true;
            log('Stop requested...');
        }
    </script>
</body>
</html>
